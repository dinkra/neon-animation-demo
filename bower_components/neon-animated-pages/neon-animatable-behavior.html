<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">

<script>

  Polymer.NeonAnimatableBehavior = {

    properties: {

      /**
       * Convenience property for setting an 'entry' animation. Do not set _animationConfig.entry
       * manually if using this. The animated node is set to `this` if using this property.
       */
      entryAnimation: {
        observer: '_entryAnimationChanged',
        type: String
      },

      /**
       * Convenience property for setting an 'exit' animation. Do not set _animationConfig.exit
       * manually if using this. The animated node is set to `this` if using this property.
       */
      exitAnimation: {
        observer: '_exitAnimationChanged',
        type: String
      }

    },

    _entryAnimationChanged: function() {
      this._animationConfig = this._animationConfig || {};
      this._animationConfig['entry'] = [{
        name: this.entryAnimation,
        node: this
      }];
    },

    _exitAnimationChanged: function() {
      this._animationConfig = this._animationConfig || {};
      this._animationConfig['exit'] = [{
        name: this.exitAnimation,
        node: this
      }];
    },

    _cloneConfig: function(config) {
      var clone = {};
      for (property in config) {
        clone[property] = config[property];
      }
      return clone;
    },

    _mergeConfigs: function(map, allConfigs, configs) {
      // map should contain all the configs seen so far with an id
      for (var config, index = 0; config = configs[index]; index++) {

        if (config.id) {

          if (map[config.id]) {
            // if a config with the same id is in the map, merge the configs
            for (var property in config) {
              map[config.id][property] = config[property];
            }
          } else {
            // otherwise put this in the map
            map[config.id] = this._cloneConfig(config);
          }

        } else {
          allConfigs.push(config);
        }

      }
      return allConfigs;
    },

    getAnimationConfig: function(type) {
      if (!this._animationConfig) {
        return [];
      }

      var allConfigs = [];
      var map = [];
      // type is optional
      var thisConfig = (type !== undefined) ? this._animationConfig[type] : this._animationConfig;
      if (thisConfig) {
        for (var config, index = 0; config = thisConfig[index]; index++) {
          if (config.animatable) {
            allConfigs = this._mergeConfigs(map, allConfigs, config.animatable.getAnimationConfig(config.type || type));
          } else {
            // put any configs with an id into a map
            if (config.id) {
              map[config.id] = this._cloneConfig(config);
            } else {
              allConfigs.push(config);
            }
          }
        }
        // append merged configs
        for (var key in map) {
          allConfigs.push(map[key]);
        }
      }
      return allConfigs;
    }

  };

</script>
