<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-selector/iron-selectable.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="neon-animation-runner-behavior.html">

<dom-module id="neon-animated-pages">

  <style>

    :host {
      display: block;
      position: relative;
    }

    :host > ::content > * {
      @apply(--layout-fit);

      display: none !important;
    }

  </style>

  <template>
    <content></content>
  </template>

</dom-module>

<script>
(function() {

  Polymer({

    is: 'neon-animated-pages',

    behaviors: [
      Polymer.IronResizableBehavior,
      Polymer.IronSelectableBehavior,
      Polymer.NeonAnimationRunnerBehavior
    ],

    properties: {

      activateEvent: {
        value: ''
      },

      _prevSelected: {
        type: String
      }

    },

    observers: [
      '_selectedChanged(selected)'
    ],

    _mergeConfigs: function(config1, config2) {
      var allConfigs = [];
      var map = {};
      // put configs with an id property from config1 into a map
      for (var config, index = 0; config = config1[index]; index++) {
        if (config.id) {
          map[config.id] = config;
        }
        allConfigs.push(config);
      }
      // if the same id is defined in config2, merge the objects
      for (var config, index = 0; config = config2[index]; index++) {
        if (config.id && map[config.id]) {
          var merged = {};
          for (var property in map[config.id]) {
            merged[property] = map[config.id][property];
          }
          for (var property in config) {
            merged[property] = config[property];
          }
          allConfigs.push(merged);
        } else {
          allConfigs.push(config);
        }
      }
      return allConfigs;
    },

    _selectedChanged: function(selected) {
      var selectedPage = this.items[this.selected];
      var oldPage = this.items[this._prevSelected];

      this._prevSelected = this.selected;

      if (!oldPage) {
        selectedPage.style.setProperty('display', 'block', 'important');
        return;
      }

      // make both pages visible
      selectedPage.style.setProperty('display', 'block', 'important');
      selectedPage.style.setProperty('display', 'block', 'important');

      // configure the animation
      var selectedConfig = selectedPage.getAnimationConfig('entry') || [];
      var oldConfig = oldPage.getAnimationConfig('exit') || [];
      var allConfigs = this._mergeConfigs(selectedConfig, oldConfig);

      var allAnimations = this.configureAndRunAnimationEffects(allConfigs, [oldPage, selectedPage], function() {
        oldPage.style.display = '';
        this.async(this.notifyResize);
      });

    }

  })

})();
</script>
